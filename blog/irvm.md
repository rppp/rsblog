### LLVM IR混合执行虚拟机/C++冷更新工具

原理是使用clang将C++编译为LLVM IR，再解释执行IR，从而实现C++代码冷更新。（冷更新和热更新不同，热更新又称热重载、热代码补丁、动态代码更新、动态软件更新）

![](/pic/irvm1.png)

具体原理：

- 实现了一个vm生成器，可自动生成高效的虚拟机
- 实现了一个C++运行时，可以动态管理和注册native函数和全局变量
- 实现了一个复杂的多文件IR diff算法
- 额外提供大量的intrinsic函数

特性列表：

- 使用简单。只需准备好旧版本和新版本的代码，其它所有的事全都可以交给该工具自动执行
- 高计算性能。纯解释执行时，在数学计算、排序、矩阵、递归等多项测试中达到wasm3或web49的90%，达到native的19%。比LLVM官方解释器快10倍以上
- 高FFI性能。vm与native交互时使用整型index，不使用字符串，不进行类型转换，达到O(1)极限性能
- 虚拟机自动生成、弹性虚拟机。可根据待编译的代码自由伸缩，平衡代码段大小和性能
- 快速内存访问。vm执行时自身不使用堆内存，不调用任何malloc、new，完全是stack only
- 支持函数粒度混合执行。vm与native随意切换，未更新的代码仍使用native执行，达到极限的运行性能
- 游戏首包性能影响最小化。未更新时达到游戏原本性能的98%
- 高编译性能。支持UE本身的并行编译。10个进程10分钟就可以把8.7GB IR编译成字节码
- 支持super instruction。得益于vm自动生成，多条指令可合并成一条
- 高灵活性。支持随意冷更新，无工程上限制。即支持对C++进行任意的增加、删除、修改，如修改全局变量的值、增加全局变量、删除一个全局变量、增加函数、删除函数、修改函数签名、删除结构体的某个成员变量、删除整个结构体、新增结构体、增删改函数指针、增删改可变参数函数、增删改虚函数等。
- vm可在动态和静态之间任意挪动。因vm是自动生成的，且IR解析支持任意内存对象序列化和反序列化，所以每一条IR指令都可以将自身部分或全部转换成动态或静态执行，动态执行速度较慢，但代码段小，静态执行速度较快，但代码段大，即可在解释执行和AOT间自由挪动。这与lisp的代码即数据很像，即代码可以在编译时和运行时之间任意挪动
- 游戏包体增量最小化。call native的FFI仅使用一个通用函数，call vm的FFI也仅使用一个通用函数，第一个包每个函数仅增加13字节
- 高安全性。因vm可伸缩，指令数量是可配置的，无源码时几乎不可能逆向该虚拟机的代码逻辑
- 跨平台。支持IOS arm64、Mac arm64、Android arm64、Linux x64，理论上支持Windows x64
- 多线程完美兼容。同构虚拟机设计，对每个平台采用该平台的缓存/内存一致性模型
- 支持虚拟机自解释。支持元虚拟机，虚拟机可无限嵌套运行
- 几乎支持C++17和LLVM9/14/15的全部特性。包括atomic、volatile、SIMD、异常等（解释执行内联汇编暂不支持）
- 不仅支持C++，还支持所有能编译成LLVM IR的语言。因其本质是一个IR虚拟机，工作于IR层面
- 支持复杂的自动化测试。包括随机部分切换vm与native、大量单元测试、通过UE5引擎和clang15两个巨型项目导出上亿行文本IR验证，保证虚拟机的稳定性。

未来计划：

- JIT支持。目前主要依赖解释执行和AOT。引入LLVM JIT可提升windows和android平台下的性能。（IOS不能JIT）
- 垃圾回收。与UE本身的GC配合。
- 更细粒度的冷更新/热更新。可以考虑实现基本块级别的混合执行，而不仅仅是函数级别。
- 进一步探索SIMD和SIMT混合执行、cpu和gpu混合执行、vm在cpu和gpu之间任意挪动、shader热更新。
- 目前支持arm64和x64，可以考虑扩展到更多平台，如RISC-V、WebAssembly等。
- 动态类型支持。可能需要修改vm的类型系统和添加动态分发机制。
- 性能分析和自适应优化。实现更复杂的运行时性能分析系统，根据实际运行情况自动调整优化策略。
- 安全性增强。添加更多安全特性，如沙箱执行、内存保护等。
- 调试支持。增强调试能力，如支持断点、单步执行、变量检查等，使开发者更容易诊断问题。
- 跨语言互操作性。支持混合语言无缝融合。
- 动态软件更新/热更新完善。目前以冷更新为主，需进一步支持更新正在执行的代码。通常来说，安全地热更新是不可判定的，但依然可以有限制地热更新。
- 指令集扩展。探索添加特定领域指令来优化常见操作，如图形处理、AI等。
- 硬件指令转译支持。该虚拟机目前工作于IR层面，仅仅只是一个HLVM（高级语言虚拟机），可增加一个硬件指令到IR的逆向转译器（已有一些指令集提升的开源项目），即可支持操作系统或进程的虚拟执行，有望向qemu发起挑战。

参考资料：

- xLua、InjectFix、HybridCLR、Mono的Mixed Mode Execution、LLVM官方解释器
- ANA: a method for ARM-on-ARM execution
- vmgen: a generator of efficient virtual machine interpreters
- WHOLE-PROGRAM DYNAMIC SOFTWARE UPDATING
- A Theory of Dynamic Software Updates
- Dynamic Code Updates
- Formalizing Dynamic Software Updating
- Binary Code Patching An Ancient Art

本文节选自视频32分09秒

[UFSH2023]虚幻引擎5大世界百人射击游戏的跨平台 | 伊诺 章瑞兹 S1项目_哔哩哔哩_bilibili

![](/pic/irvm2.png)
